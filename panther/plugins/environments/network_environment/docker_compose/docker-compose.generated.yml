
services:
  
  picoquic_server:
    image: picoquic_rfc9000_panther:latest
    container_name: picoquic_server
    ports:
      
      - "4443:4443"
      
      - "8080:8080"
      
    
    # 
    # healthcheck:
    #   test: ["CMD", "curl", "-f", "http://localhost:/health"]
    #   interval: 5s
    #   timeout: 2s
    #   retries: 5
    #   start_period: 5s
    # 
    environment:
      ROLE: server
      # TODO
      SSLKEYLOGFILE: "/app/logs/sslkeylogfile.txt" 
      UID: "${UID}"
      GID: "${GID}"
      
    tty: true
    stdin_open: true
    # user: "${UID}:${GID}"
    # Not needed with user
    # privileged: true
    cap_add:
      - CAP_NET_ADMIN
      - CAP_NET_RAW
    working_dir: "/opt/picoquic"
    command: 
      # TODO protocol + duration
      - "(tshark -a duration:10 -i any -w /app/logs/picoquic_server.pcap;) & (sleep 2; ./picoquicdemo -c /opt/certs/cert.pem -k /opt/certs/key.pem -a hq-interop -l - -n servername -D -L  -e eth0  -p 4443 > /app/logs/server.log 2>&1)"
    volumes:
      - "/home/crochetch/Documents/Projects/VerificationQUIC/PANTHER-SCP/panther/outputs/experiment_2024-10-17_10-22-31/logs/picoquic_server/:/app/logs/"
      
      - "/home/crochetch/Documents/Projects/VerificationQUIC/PANTHER-SCP/panther/config/certs/cert.pem:/opt/certs/cert.pem"
      
      - "/home/crochetch/Documents/Projects/VerificationQUIC/PANTHER-SCP/panther/config/certs/key.pem:/opt/certs/key.pem"
      
      - "/home/crochetch/Documents/Projects/VerificationQUIC/PANTHER-SCP/panther/config/tls_keys:/opt/ticket/ticket.key"
      
    networks:
      panther_network:
        aliases: 
          - picoquic_server
  
  picoquic_client:
    image: picoquic_rfc9000_panther:latest
    container_name: picoquic_client
    ports:
      
      - "5000:5000"
      
      - "8081:8081"
      
    
    depends_on:
      - picoquic_server
        # condition: service_healthy
    
    # 
    environment:
      ROLE: client
      # TODO
      SSLKEYLOGFILE: "/app/logs/sslkeylogfile.txt" 
      UID: "${UID}"
      GID: "${GID}"
      
      TARGET: picoquic_server
      MESSAGE: ""
      
    tty: true
    stdin_open: true
    # user: "${UID}:${GID}"
    # Not needed with user
    # privileged: true
    cap_add:
      - CAP_NET_ADMIN
      - CAP_NET_RAW
    working_dir: "/opt/picoquic"
    command: 
      # TODO protocol + duration
      - "(tshark -a duration:10 -i any -w /app/logs/picoquic_client.pcap;) & (sleep 2; sleep 5;./picoquicdemo -c /opt/certs/cert.pem -k /opt/certs/key.pem -T /opt/ticket/ticket.key -a hq-interop -l - -D -L  -e eth0   -v 00000001  picoquic_server 4443 > /app/logs/client.log 2>&1)"
    volumes:
      - "/home/crochetch/Documents/Projects/VerificationQUIC/PANTHER-SCP/panther/outputs/experiment_2024-10-17_10-22-31/logs/picoquic_client/:/app/logs/"
      
      - "/home/crochetch/Documents/Projects/VerificationQUIC/PANTHER-SCP/panther/config/certs/cert.pem:/opt/certs/cert.pem"
      
      - "/home/crochetch/Documents/Projects/VerificationQUIC/PANTHER-SCP/panther/config/certs/key.pem:/opt/certs/key.pem"
      
      - "/home/crochetch/Documents/Projects/VerificationQUIC/PANTHER-SCP/panther/config/tls_keys:/opt/ticket/ticket.key"
      
    networks:
      panther_network:
        aliases: 
          - picoquic_client
  

networks:
  panther_network:
    driver: bridge